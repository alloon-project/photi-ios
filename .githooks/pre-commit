#!/bin/sh

LINT="${PWD}/swiftlint"

echo "ğŸš€  SwiftLint ì‹œì‘..."
echo "ğŸ”  lint ì ìš© ê²½ë¡œ: $(pwd)"
# Stagingëœ ëª¨ë“  íŒŒì¼ ê°€ì ¸ì˜¤ê¸°
stagingFiles=$(git diff --cached --name-only)

# Stagingëœ Swift íŒŒì¼ ê°€ì ¸ì˜¤ê¸°
targets=$(echo "$stagingFiles" | grep -E "\.swift$")

echo "ğŸ”  Staing íŒŒì¼ ëª©ë¡:"
echo $stagingFiles

echo "ğŸ”  ëŒ€ìƒ íŒŒì¼ ëª©ë¡:"
echo $targets

if [ -z "$targets" ]; then 
  printf "ğŸ·ï¸  SwiftLintë¥¼ ê²€ì‚¬í•  íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤. ìˆ˜ê³ í•˜ì…¨ìŠµë‹ˆë‹¤"
  exit 0
fi

# lint rule ì •ì˜ íŒŒì¼
RESULT=$(echo "$targets" | xargs $LINT lint --quiet --config ${PWD}/.swiftlint.yml)
if [ "$RESULT" == '' ]; then
	printf "âœ¨  SwiftLint ì ìš©ì„ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤!! ê³ ìƒí•˜ì…¨ìŠµë‹ˆë‹¤:)\n"
  exit 0
fi
echo ""
printf "ğŸš« SwiftLint Failed ì•„ë˜ ë‚´ìš©ì„ í™•ì¸í•´ì£¼ì„¸ìš”:\n"
echo "$RESULT" | while IFS= read -r line; do
  FILE=$(echo "$line" | cut -d ":" -f 1)
  LINE_NO=$(echo "$line" | cut -d ":" -f 2)
  COLUMN=$(echo "$line" | cut -d ":" -f 3)
  TYPE=$(echo "$line" | awk -F ": " '{print $2}' | awk '{print $1}')
  MESSAGE=$(echo "$line" | awk -F ": " '{print $2}' | cut -d "(" -f 1)
  RULE=$(echo "$line" | awk -F "(" '{print $2}' | tr -d ")")

  if [ "$TYPE" = "warning" ]; then
    echo "ğŸš§ [WARNING] $FILE:$LINE_NO:$COLUMN"
    echo "    ğŸ“Œ $MESSAGE ($RULE)"
  elif [ "$TYPE" = "error" ]; then
    echo "ğŸš¨ [ERROR] $FILE:$LINE_NO:$COLUMN"
    echo "    ğŸ“Œ $MESSAGE ($RULE)"
  fi
  echo ""
done
printf "\n ğŸš‘  ì»¤ë°‹ì‹¤íŒ¨!! Swiftlint ruleì— ë§ê²Œ ì½”ë“œë¥¼ ë³€ê²½í•´ì£¼ì„¸ìš”:)\n"
exit 1