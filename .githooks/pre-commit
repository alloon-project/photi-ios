#!/bin/sh

LINT="${PWD}/swiftlint"

echo "ğŸš€  SwiftLint ì‹œì‘..."
echo "ğŸ”  lint ì ìš© ê²½ë¡œ: $(pwd)"
# Stagingëœ ëª¨ë“  íŒŒì¼ ê°€ì ¸ì˜¤ê¸°
stagingFiles=$(git diff --cached --name-only)

# Stagingëœ Swift íŒŒì¼ ê°€ì ¸ì˜¤ê¸°
targets=$(echo "$stagingFiles" | grep -E "\.swift$")

echo "ğŸ”  Staing íŒŒì¼ ëª©ë¡:"
echo $stagingFiles

echo "ğŸ”  ëŒ€ìƒ íŒŒì¼ ëª©ë¡:"
echo $targets

if [ -z "$targets" ]; then 
  printf "ğŸ·ï¸  SwiftLintë¥¼ ê²€ì‚¬í•  íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤. ìˆ˜ê³ í•˜ì…¨ìŠµë‹ˆë‹¤"
  exit 0
fi

# lint rule ì •ì˜ íŒŒì¼
RESULT=$($LINT lint --quiet --config ${PWD}/.swiftlint.yml -- $targets)
if [ "$RESULT" == '' ]; then
	printf "âœ¨  SwiftLint ì ìš©ì„ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤!! ê³ ìƒí•˜ì…¨ìŠµë‹ˆë‹¤:)\n"
  exit 0
fi
echo ""
printf "âœ” SwiftLint Failed ì•„ë˜ ë‚´ìš©ì„ í™•ì¸í•´ì£¼ì„¸ìš”:\n"
while read -r line; do
  FILEPATH=$(echo $line | cut -d : -f 1)
  L=$(echo $line | cut -d : -f 2)
  C=$(echo $line | cut -d : -f 3)
  TYPE=$(echo $line | cut -d : -f 4 | cut -c 2-)
  MESSAGE=$(echo $line | cut -d : -f 5 | cut -c 2-)
  DESCRIPTION=$(echo $line | cut -d : -f 6 | cut -c 2-)
  if [ $TYPE == 'warning' ]; then
    printf "\n ğŸš§  $TYPE\n"
    printf "    $FILEPATH:$L:$C\n"
    printf "    ğŸ“Œ  $MESSAGE: - $DESCRIPTION\n"
  elif [ $TYPE == 'error' ]; then
    printf "\n ğŸš¨  $TYPE\n"
  fi
done <<< "$RESULT"
printf "\n ğŸš‘  ì»¤ë°‹ì‹¤íŒ¨!! Swiftlint ruleì— ë§ê²Œ ì½”ë“œë¥¼ ë³€ê²½í•´ì£¼ì„¸ìš”:)\n"
exit 1